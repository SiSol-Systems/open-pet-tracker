GENERATOR_LAUNCHERS_SPLASHES = [
    {"size": [36, 36], "filename": "icon.png", "folders": ["drawable", "drawable-ldpi"], "os": "Android", "type" : "launcher_round"},
    {"size": [48, 48], "filename": "icon.png", "folders": ["drawable-mdpi"], "os": "Android", "type" : "launcher_round"},
    {"size": [72, 72], "filename": "icon.png", "folders": ["drawable-hdpi"], "os": "Android", "type" : "launcher_round"},
    {"size": [96, 96], "filename": "icon.png", "folders": ["drawable-xhdpi"], "os": "Android", "type" : "launcher_round"},
	{"size": [144, 144], "filename": "icon.png", "folders": ["drawable-xxhdpi"], "os": "Android", "type" : "launcher_round"},
	{"size": [192, 192], "filename": "icon.png", "folders": ["drawable-xxxhdpi"], "os": "Android", "type" : "launcher_round"},
    {"size": [512, 512], "filename": "storehighres.png", "folders": ["google-store"], "os": "Android", "type" : "store"},
    {"size": [1024, 500], "filename": "storefunctional.png", "folders": ["google-store"], "os": "Android", "type" : "store"},
    {"size": [800, 480], "filename": "screen.png", "folders": ["drawable-land-hdpi"], "os": "Android", "type" : "splash"},
    {"size": [320, 200], "filename": "screen.png", "folders": ["drawable-land-ldpi"], "os": "Android", "type" : "splash"},
    {"size": [480, 320], "filename": "screen.png", "folders": ["drawable-land-mdpi"], "os": "Android", "type" : "splash"},
    {"size": [1280, 720], "filename": "screen.png", "folders": ["drawable-land-xhdpi"], "os": "Android", "type" : "splash"},
    {"size": [480, 800], "filename": "screen.png", "folders": ["drawable-port-hdpi"], "os": "Android", "type" : "splash"},
    {"size": [200, 320], "filename": "screen.png", "folders": ["drawable-port-ldpi"], "os": "Android", "type" : "splash"},
    {"size": [320, 480], "filename": "screen.png", "folders": ["drawable-port-mdpi"], "os": "Android", "type" : "splash"},
    {"size": [720, 1280], "filename": "screen.png", "folders": ["drawable-port-xhdpi"], "os": "Android", "type" : "splash"},
    {"size": [40, 40], "filename": "icon-40.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [80, 80], "filename": "icon-40@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [50, 50], "filename": "icon-50.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [100, 100], "filename": "icon-50@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [60, 60], "filename": "icon-60.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [120, 120], "filename": "icon-60@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [72, 72], "filename": "icon-72.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [144, 144], "filename": "icon-72@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [76, 76], "filename": "icon-76.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [152, 152], "filename": "icon-76@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [29, 29], "filename": "icon-small.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [58, 58], "filename": "icon-small@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [57, 57], "filename": "icon.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [114, 114], "filename": "icon@2x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [180, 180], "filename": "icon-60@3x.png", "folders": ["icons"], "os": "iOS", "type" : "launcher_round"},
    {"size": [640, 1136], "filename": "Default-568h@2x~iphone.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [750, 1334], "filename": "Default-667h.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [1242, 2208], "filename": "Default-736h.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [2208, 1242], "filename": "Default-Landscape-736h.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [1536, 2048], "filename": "Default-Portrait@2x~ipad.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [768, 1024], "filename": "Default-Portrait~ipad.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [640, 960], "filename": "Default@2x~iphone.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [320, 480], "filename": "Default~iphone.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [2048, 1536], "filename": "Default-Landscape@2x~ipad.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [1024, 768], "filename": "Default-Landscape~ipad.png", "folders": ["splash"], "os": "iOS", "type" : "splash"},
    {"size": [620, 300], "filename": "SplashScreen.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "splash"},
    {"size": [1152, 1920], "filename": "SplashScreenPhone.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "splash"},
    {"size": [30, 30], "filename": "Square30x30Logo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [106, 106], "filename": "Square44x44Logo.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [70, 70], "filename": "Square70x70Logo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [170, 170], "filename": "Square71x71Logo.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [150, 150], "filename": "Square150x150Logo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [360, 360], "filename": "Square150x150Logo.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [310, 310], "filename": "Square310x310Logo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [50, 50], "filename": "StoreLogo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [120, 120], "filename": "StoreLogo.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "launcher"},
    {"size": [310, 150], "filename": "Wide310x150Logo.scale-100.png", "folders": ["windows"], "os": "windows", "type" : "splash"},
    {"size": [744, 360], "filename": "Wide310x150Logo.scale-240.png", "folders": ["windows"], "os": "windows", "type" : "splash"},
    {"size": [300, 300], "filename": "WindowsPhoneStore-300x300.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [1000, 800], "filename": "WindowsPhoneStore-1000x800.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [358, 358], "filename": "WindowsPhoneStore-358x358.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [358, 173], "filename": "WindowsPhoneStore-358x173.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [846, 468], "filename": "WindowsPhoneStore-846x468.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [558, 756], "filename": "WindowsPhoneStore-558x756.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [414, 468], "filename": "WindowsPhoneStore-414x468.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [414, 180], "filename": "WindowsPhoneStore-414x180.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
    {"size": [558, 558], "filename": "WindowsPhoneStore-558x558.png", "folders": ["windows-store"], "os": "windows", "type" : "store"},
]


def query_svg(svgfile):
    """Parses the output from inkscape --query-all"""
    def parse_line(line):
        split = line.split(b',')
        return [split[0]] + [float(x) for x in split[1:]]
    
    output = check_output(["inkscape", "--query-all", svgfile])
    lines = output.split(b'\n')
    info = [parse_line(line) for line in lines]
    return info[0]

# apppath is needed for the execution of the shell command only   
def export_from_svg(apppath, sourcepath, destination_folder, filename, size):

    name, x, y, width, height = query_svg(sourcepath)

    if "auto" in size:
        if size.index("auto") == 0:
            # use fixed height
            xdiff = 1
            ydiff = 0
        else:
            xdiff = 0
            ydiff = 1

    else:
        # maintain proportions
        xdiff = abs(width - size[0])
        ydiff = abs(height - size[1])

    if xdiff < ydiff:
        print("using fixed width")
        shrink_factor = size[0]/width
        exportwidth = size[0]
        exportheight = int(height * shrink_factor)

    else:
        print("using fixed height")
        shrink_factor = size[1]/height
        exportheight = size[1]
        exportwidth = int(width * shrink_factor)


    destination = os.path.join(destination_folder, filename)

    command = ["inkscape", "--export-png=%s" % destination, "--export-width=%i" % exportwidth, "--export-height=%i" % exportheight, sourcepath]
                
    process = Popen(command, stdout=PIPE, cwd=apppath)
                # wait until the subprocess is finished
    process.communicate()

    # crop the image if auto is not set
    if "auto" not in size:
        imageFile = Image.open(destination)
        imageFile_cropped = ImageOps.fit(imageFile, size, Image.ANTIALIAS)
        imageFile_cropped.save(destination, "PNG" )


if __name__ == "__main__":
    import json, os, sys
    from PIL import Image, ImageOps
    from subprocess import CalledProcessError, check_output, Popen, PIPE


    apppath = os.path.dirname(os.path.realpath(__file__))

    orientation = None
    filename = None
    rect = False

    argv = sys.argv
    i = 0
    while i < len(argv):
        arg = argv[i]

        if arg == '-filename':
            filename = argv[i+1]
                    
        if arg == '-orientation':
            orientation = argv[i+1]

        if arg == '--rect':
            rect = True
        

        i = i + 1

    destination_root = os.path.join(apppath, "created")

    if orientation is not None and filename is not None:

        sourcepath = os.path.join(apppath, filename)

        print(sourcepath)

        if os.path.isfile(sourcepath):
    
            for graphic in GENERATOR_LAUNCHERS_SPLASHES:

                if orientation == "launcher":

                    if rect == True and (graphic["type"] == "launcher" or (graphic["type"] == "store" and graphic["size"][0] == graphic["size"][1])):
                        
                        for folder in graphic["folders"]:

                            destination_folder = os.path.join(destination_root, folder)

                            if not os.path.isdir(destination_folder):
                                os.makedirs(destination_folder)
                            
                            export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])


                    if rect == False and graphic["type"] == "launcher_round":

                        for folder in graphic["folders"]:

                            destination_folder = os.path.join(destination_root, folder)

                            if not os.path.isdir(destination_folder):
                                os.makedirs(destination_folder)
                            
                            export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])

                else:

                    if graphic["type"] == "splash":

                        for folder in graphic["folders"]:

                            destination_folder = os.path.join(destination_root, folder)

                            if not os.path.isdir(destination_folder):
                                os.makedirs(destination_folder)

                            if orientation == "portrait" and graphic["size"][0] <= graphic["size"][1]:
                                export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])

                            elif orientation == "landscape" and graphic["size"][0] >= graphic["size"][1]:
                                export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])
                                
                    elif graphic["type"] == "store":
                        
                        for folder in graphic["folders"]:

                            destination_folder = os.path.join(destination_root, folder)

                            if not os.path.isdir(destination_folder):
                                os.makedirs(destination_folder)

                            if orientation == "portrait" and graphic["size"][0] <= graphic["size"][1]:
                                export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])

                            elif orientation == "landscape" and graphic["size"][0] > graphic["size"][1]:
                                export_from_svg(apppath, sourcepath, destination_folder, graphic["filename"], graphic["size"])

                            
        else:
            print("file not found")
    else:
        print ("no filename or orientation given")
